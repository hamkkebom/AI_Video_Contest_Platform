<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="doc-version" content="v0.1-mockup">
  <meta name="doc-status" content="목업 기준 초안">
  <meta name="last-modified" content="2026-02-19">
  <meta name="project" content="함께봄 AI 영상 공모전 플랫폼">
  <title>시스템 아키텍처 설계서 - 함께봄 AI 영상 공모전 플랫폼</title>
  <link rel="stylesheet" href="../assets/style.css">
  <link rel="stylesheet" href="../assets/print.css">
</head>
<body>
  <main>
    <h1>🏗️ 시스템 아키텍처 설계서</h1>
    <p>Next.js 15, Supabase, Mux, Vercel 기반 목업 시스템의 런타임/배포/추적 구조를 정의한다.</p>
    <button id="pdf-button" class="pdf-button" type="button">📄 PDF 다운로드</button>
    <div class="doc-meta">
      <strong>문서 정보:</strong> v0.1-mockup | 최종 수정: 2026-02-19 | 상태: 목업 기준 초안
    </div>

    <h2>1. 전체 시스템 구조</h2>
    <div class="mermaid">
flowchart TB
  U[사용자\nGuest/Participant/Host/Judge/Admin] --> N[Next.js 15 App\non Vercel]
  N --> MW[middleware.ts\nUTM Capture]
  N --> API[Route Handlers\n/api/*]
  API --> AUTH[Supabase Auth\nJWT 검증]
  API --> DB[(Supabase Postgres)]
  N --> UPL[/api/uploads/direct]
  UPL --> MUX[Mux Direct Upload API]
  MUX --> PLAY[Mux Playback CDN]
  N --> PLAY
  MW --> TRK[/api/track]
  TRK --> AN[(analytics schema)]
    </div>

    <h2>2. 클라이언트/서버 구조 (RSC vs Client)</h2>
    <table>
      <thead>
        <tr>
          <th>영역</th>
          <th>Server Component (RSC)</th>
          <th>Client Component</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>주요 책임</td>
          <td>초기 데이터 패칭, SEO 메타 생성, 권한별 초기 렌더링</td>
          <td>좋아요 토글, 실시간 카운터, 무한 스크롤 상호작용</td>
        </tr>
        <tr>
          <td>데이터 전략</td>
          <td>ISR 기반 캐시 데이터 제공</td>
          <td>SWR 재검증으로 최신 상태 반영</td>
        </tr>
        <tr>
          <td>주요 페이지</td>
          <td>/contests, /gallery/[id] 초기 렌더</td>
          <td>검색 필터 패널, 심사 입력폼, 좋아요 버튼</td>
        </tr>
      </tbody>
    </table>

    <h2>3. 업로드 구조 (영상 파일 → Mux → Playback ID 저장)</h2>
    <div class="mermaid">
sequenceDiagram
  participant User as Participant
  participant App as Next.js Client
  participant API as /api/uploads/direct
  participant Mux as Mux
  participant DB as Supabase

  User->>App: 영상 파일 선택
  App->>API: Direct Upload URL 요청
  API->>Mux: Upload URL 생성
  Mux-->>API: uploadId, uploadUrl 반환
  API-->>App: uploadUrl 전달
  App->>Mux: 파일 업로드
  Mux-->>App: assetId 생성 완료
  App->>API: 제출 생성 요청(assetId 포함)
  API->>DB: submission 저장(videoUrl/playbackId)
  DB-->>App: submissionId 반환
    </div>

    <h2>4. 배포 구조</h2>
    <table>
      <thead>
        <tr>
          <th>레이어</th>
          <th>구성</th>
          <th>비고</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>App/SSR</td>
          <td>Vercel</td>
          <td>App Router, ISR, Edge middleware 실행</td>
        </tr>
        <tr>
          <td>Data/Auth</td>
          <td>Supabase (Postgres + Auth)</td>
          <td>운영 도메인 스키마 + analytics 스키마 병행</td>
        </tr>
        <tr>
          <td>Video</td>
          <td>Mux + CDN</td>
          <td>스트리밍 처리 분리로 앱 서버 부하 감소</td>
        </tr>
      </tbody>
    </table>

    <h2>5. 캐싱 전략 (ISR + SWR)</h2>
    <table>
      <thead>
        <tr>
          <th>대상</th>
          <th>전략</th>
          <th>기준</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>/gallery/[id]</td>
          <td>ISR (revalidate 60~300초)</td>
          <td>동시 접속 시 캐시 응답, SEO 유지</td>
        </tr>
        <tr>
          <td>조회수/좋아요</td>
          <td>Client SWR</td>
          <td>실시간 데이터만 분리 갱신</td>
        </tr>
        <tr>
          <td>다음 영상 진입</td>
          <td>Link prefetch + router.prefetch</td>
          <td>무한 스크롤 이동 체감 지연 축소</td>
        </tr>
      </tbody>
    </table>

    <h2>6. UTM 추적 구조</h2>
    <div class="mermaid">
flowchart LR
  UTM[유입 URL\nutm_source/utm_medium/utm_campaign] --> MID[middleware.ts]
  MID --> CK[쿠키 저장\nfirst-touch + last-touch]
  CK --> TRACK[/api/track]
  TRACK --> V[(analytics.visitors)]
  TRACK --> S[(analytics.sessions)]
  TRACK --> E[(analytics.events)]
  TRACK --> I[(analytics.identity_links)]
  E --> DASH[관리자 성과 대시보드]
    </div>
  </main>
  <script src="../assets/docs.js" defer></script>
</body>
</html>
